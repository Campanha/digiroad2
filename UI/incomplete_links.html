<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/jquery-migrate/jquery-migrate.min.js"></script>
    <script type="text/javascript" src="bower_components/lodash/dist/lodash.min.js"></script>
    <script type="text/javascript" src="src/utils/backend-utils.js"></script>
    <script type="text/javascript" src="src/utils/environment-utils.js"></script>
    <script type="text/javascript" src="src/analytics.js"></script>
    <link rel="stylesheet" type="text/css" href="css/digiroad2.css">
    <!-- Google Analytics loaded asynchronously -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
    <title>Digiroad 2 korjattavat tielinkit</title>
</head>
<body onload="fetchIncompleteLinks()" style="overflow: auto;">
    <div class="page">
        <div class="content-box">
            <header>Korjattavien linkkien lista</header>
            <div class="incomplete-links">
            </div>
        </div>
    </div>
    <script type="application/javascript">
        var incompleteLinksTableForMunicipality = function(municipalityName, mmlIdsByAdministrativeClass) {
            var municipalityHeader = function(municipalityName) {
                return $('<h2/>').html(municipalityName);
            };
            var tableHeaderRow = function(administrativeClass) {
                return $('<caption/>').html(administrativeClass);
            };
            var tableContentRows = function(mmlIds) {
                return _.map(mmlIds, function(id) {
                    return $('<tr/>').append($('<td/>').append(assetLink(id)));
                });
            };
            var assetLink = function(mmlId) {
                var link =  Environment.urlPath() + '/#linkProperties/' + mmlId;
                return $('<a/>').attr('href', link).html(link);
            };
            var tableForAdministrativeClass = function(administrativeClass, mmlIds) {
                if (!mmlIds || mmlIds.length === 0) return '';
                return $('<table/>').addClass('table')
                        .append(tableHeaderRow(administrativeClass))
                        .append(tableContentRows(mmlIds));
            };
            return $('<div/>').append(municipalityHeader(municipalityName))
                    .append(tableForAdministrativeClass('Valtion omistama', mmlIdsByAdministrativeClass.State))
                    .append(tableForAdministrativeClass('Kunnan omistama', mmlIdsByAdministrativeClass.Municipality))
                    .append(tableForAdministrativeClass('Yksityisen omistama', mmlIdsByAdministrativeClass.Private))
                    .append(tableForAdministrativeClass('Ei tiedossa', mmlIdsByAdministrativeClass.Unknown));
        };

        var fetchIncompleteLinks = function() {
            var backend = new Backend();
            backend.getIncompleteLinksWithCallBack(function(links) {
                _.map(links, function(mmlIdsByAdministrativeClass, municipalityName) {
                    $('.incomplete-links').append(incompleteLinksTableForMunicipality(municipalityName, mmlIdsByAdministrativeClass));
                });
            });
        };
    </script>
    <script type="application/javascript">
        Analytics.start();
    </script>
</body>
</html>
