<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/jquery-migrate/jquery-migrate.min.js"></script>
    <script type="text/javascript" src="bower_components/lodash/dist/lodash.min.js"></script>
    <script type="text/javascript" src="src/utils/backend-utils.js"></script>
    <link rel="stylesheet" type="text/css" href="css/digiroad2.css">
    <title>Digiroad 2 kelluvat pysäkit</title>
</head>
<body onload="fetchFloatingStops()">
    <div class="page">
        <div class="content-box form-box">
            <header>Kelluvat pysäkit</header>
            <div class="floatingStops"></div>
        </div>
    </div>
    <script type="application/javascript">
        var floatingStopsTableForMunicipality = function(municipalityName, externalIds) {
            var url = window.location.href.split('/');
            var urlParts = _.initial(_.filter(url, function(urlPart) { return !_.isEmpty(urlPart); }));
            var context = _.head(urlParts) + '//' + _.tail(urlParts).join('/');

            var tableHeaderRow = function(municipalityName) {
                return $('<tr/>').append($('<th/>').html(municipalityName));
            };
            var assetLink = function(externalId) {
                var link =  context + '/#/asset/' + externalId;
                return $('<a/>').attr('href', link).html(link);
            };
            var tableContentRows = function(externalIds) {
                return _.map(externalIds, function(id) {
                    return $('<tr/>').append($('<td/>').append(assetLink(id)));
                });
            };
            return $('<table/>').append(tableHeaderRow(municipalityName)).append(tableContentRows(externalIds));
        };

        var fetchFloatingStops = function() {
            var backend = new Backend();
            backend.getFloatingAssetsWithCallback(function(assets) {
                _.map(assets, function(externalIds, municipalityName) {
                    $('.floatingStops').append(floatingStopsTableForMunicipality(municipalityName, externalIds));
                });
            });
        };
    </script>
</body>
</html>